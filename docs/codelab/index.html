
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Basics of writing a Go CLI tool</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="codelab"
                  title="Basics of writing a Go CLI tool"
                  environment="web"
                  feedback-link="https://github.com/Zenika/catption/issues">
    
      <google-codelab-step label="Introduction" duration="0">
        <p>In this codelab you will learn the basics of writing a Go CLI tool.</p>
<h2 class="checklist" is-upgraded>What you&#39;ll learn</h2>
<ul class="checklist">
<li>Setup a development environment</li>
<li>Discover <code>os</code>, <code>os/exec</code> and <code>flag</code> packages</li>
<li>Discover <code>github.com/spf13/cobra</code> CLI library</li>
<li>Create commands and subcommands</li>
<li>Read command flags and args</li>
<li>Discover <code>github.com/spf13/viper</code> config library</li>
<li>Read and write a config file</li>
<li>Put <code>cobra</code> and <code>viper</code> together</li>
<li>Read environment variables</li>
<li>Discover <code>github.com/sirupsen/logrus</code> logging library</li>
<li>Use build time variable injection</li>
<li>Use conditional compilation and build tags</li>
</ul>
<p>The steps marked with a ğŸ are optional.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Ch.1: Introduction" duration="0">
        <h2 class="checklist" is-upgraded>What you&#39;ll learn</h2>
<ul class="checklist">
<li>Setup a development environment</li>
<li>Read args (package <code>os</code>)</li>
<li>Bonus: Read flags (package <code>flag</code>)</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Ch.1: Setup environment" duration="0">
        <p>In order to go through this codelab, you are going to need a working Go development environment.</p>
<p>The minimum required version is Go 1.12.</p>
<aside class="special"><p>Already have Go installed?<br>Make sure you are running a version &gt;= 1.12 by running <code>go version</code>.<br>If it is the case you may proceed to the next step.</p>
</aside>
<h2 is-upgraded>ğŸ§ Linux</h2>
<aside class="warning"><p>Do not use <code>apt</code> (old versions of Go)</p>
</aside>
<h3 is-upgraded>snap</h3>
<p>Run:</p>
<pre><code>sudo snap install go --classic
</code></pre>
<h3 is-upgraded>tarbal</h3>
<p>Follow the instructions at <a href="https://golang.org/doc/install#tarball" target="_blank">https://golang.org/doc/install#tarball</a></p>
<h2 is-upgraded>ğŸ Mac OS</h2>
<p>Download the package file at <a href="https://golang.org/dl/" target="_blank">https://golang.org/dl/</a>, open it, and follow the prompts.</p>
<h2 is-upgraded>ğŸ Windows</h2>
<p>Download the MSI file at <a href="https://golang.org/dl/" target="_blank">https://golang.org/dl/</a>, open it, and follow the prompts.</p>
<aside class="special"><p>Check your installation by running <code>go version</code> and <code>go env</code>.</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Ch.1: Download codelab" duration="0">
        <p>There are two ways of downloading the codelab contents.<br>The prefered way is <code>git</code>, which will allow you to keep track of your work and revert things if needed.</p>
<h2 is-upgraded>git</h2>
<p>Run:</p>
<pre><code>git clone https://github.com/Zenika/catption.git
</code></pre>
<h2 is-upgraded>zip</h2>
<p>Download <a href="https://github.com/Zenika/catption/archive/master.zip" target="_blank">https://github.com/Zenika/catption/archive/master.zip</a> and unzip it.</p>
<aside class="special"><p>Each chapter of the codelab has its own directory:<br><br><code>ğŸ“‚ catption<br>|-ğŸ“‚ codelab<br>| |-ğŸ“ chapter1<br>| |-ğŸ“ chapter2</code><br><br>Run <code>cd catption/codelab/chapter1</code> to go to chapter 1.</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Ch.1: Choose an IDE" duration="0">
        <p>The last thing you need is a Go friendly IDE.</p>
<p>If you don&#39;t already have one, here are some popular IDEs for Go:</p>
<ul>
<li><a href="https://code.visualstudio.com/" target="_blank">Visual Studio Code</a> + <a href="https://github.com/microsoft/vscode-go" target="_blank">vscode-go</a></li>
<li><a href="https://www.jetbrains.com/go/" target="_blank">Goland</a></li>
<li>vim + <a href="https://github.com/fatih/vim-go" target="_blank">vim-go</a></li>
</ul>
<p>Now open the codelab contents and you are ready ğŸ‘·, let&#39;s Go!</p>


      </google-codelab-step>
    
      <google-codelab-step label="Ch.1: Read args" duration="0">
        <h2 is-upgraded>Run <code>hello.go</code></h2>
<p>In <code>ğŸ“‚catption/codelab/chapter1</code> you will find a classic <code>hello.go</code>:</p>
<pre><code>package main

import (
	&#34;fmt&#34;
)

func main() {
	fmt.Println(&#34;Hello World!&#34;)
}
</code></pre>
<p>âŒ¨ Execute this program by running <code>go run .</code>.</p>
<h2 is-upgraded>Format the message</h2>
<p>We would like to replace <code>World</code> by a variable in our message.</p>
<p>âŒ¨ Create a new string variable:</p>
<pre><code>var recipient = &#34;Gopher&#34;
</code></pre>
<p>âŒ¨ Use <a href="https://pkg.go.dev/fmt?tab=doc#Printf" target="_blank"><code>fmt.Printf()</code></a> to format the message with <code>recipient</code>.</p>
<aside class="warning"><p>Unlike <code>fmt.Println()</code>, <code>fmt.Printf()</code> does not add a new line at the end of the string.<br>You must add it by appending <code>\n</code> at the end of the message.</p>
</aside>
<h2 is-upgraded>Read command line arguments</h2>
<p>As you can see the main function of a Go program has no parameters.</p>
<p>The command line arguments are available in the <a href="https://pkg.go.dev/os?tab=doc#pkg-variables" target="_blank"><code>Args</code> variable of the <code>os</code> package</a>.</p>
<aside class="special"><p><code>os.Args</code> has the type <code>[]string</code> (slice of string).<br>A slice is a variable length array.</p>
</aside>
<p>âŒ¨ Use <code>os.Args</code> to fill the <code>recipient</code> variable.</p>
<aside class="special"><p><a href="https://pkg.go.dev/strings?tab=doc#Join" target="_blank"><code>strings.Join</code></a> concatenates the elements of a slice of strings.</p>
</aside>
<aside class="special"><p>To extract a subset of a slice, use the slice operator.<br>Having <code>var ii = []int{1, 2, 3, 4}</code>, <code>ii[2:]</code> will give you the slice <code>[3, 4]</code></p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Ch.1: ğŸ Interpret flags" duration="0">
        <p>Flags allow to change the behavior of commands, like the <code>-r</code> flag of <code>rm</code> which enables recursive removal.</p>
<p>The <a href="https://pkg.go.dev/flag?tab=doc" target="_blank"><code>flag</code> package</a> allows to parse the flags contained in <code>os.Args</code>.</p>
<p>We would like our command to have a <code>-u</code> flag which uppercases the message:</p>
<pre><code>$ hello -u capslock
HELLO CAPSLOCK!
</code></pre>
<p>âŒ¨ Explore the <code>flag</code> package and parse the <code>-u</code> flag in <code>hello.go</code>.</p>
<aside class="special"><p><a href="https://pkg.go.dev/flag?tab=doc#Args" target="_blank"><code>flag.Args</code></a> returns the non-flag command-line arguments.</p>
</aside>
<aside class="special"><p><a href="https://pkg.go.dev/strings?tab=doc#ToUpper" target="_blank"><code>strings.ToUpper</code></a> returns an upper case copy of a string.</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Ch.1: End" duration="0">
        <p>ğŸ‰ Congratulations! You have completed chapter 1.</p>
<h2 class="checklist" is-upgraded>What we&#39;ve covered</h2>
<ul class="checklist">
<li>Setup a development environment</li>
<li>Read args (package <code>os</code>)</li>
<li>ğŸ Read flags (package <code>flag</code>)</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Ch.2: Introduction" duration="0">
        <p>Start using libraries ğŸ</p>
<h2 class="checklist" is-upgraded>What you&#39;ll learn</h2>
<ul class="checklist">
<li>Discover <code>github/spf13/cobra</code></li>
<li>Create a cobra command</li>
<li>ğŸ Validate arguments</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Ch.2: Discover cobra" duration="0">
        <p>Cobra is a library for creating powerful modern CLI applications.</p>
<p class="image-container"><img alt="Cobra" src="img/d38c66cbe9c78b20.png"></p>
<p>Cobra provides:</p>
<ul>
<li>Easy subcommand-based CLIs: <code>app server</code>, <code>app fetch</code>, etc.</li>
<li>Fully POSIX-compliant flags (including short &amp; long versions)</li>
<li>Nested subcommands</li>
<li>Global, local and cascading flags</li>
<li>Easy generation of applications &amp; commands with <code>cobra init appname</code> &amp; <code>cobra add cmdname</code></li>
<li>Intelligent suggestions (<code>app srver</code>... did you mean <code>app server</code>?)</li>
<li>Automatic help generation for commands and flags</li>
<li>Automatic help flag recognition of <code>-h</code>, <code>--help</code>, etc.</li>
<li>Automatically generated bash autocomplete for your application</li>
<li>Automatically generated man pages for your application</li>
<li>Command aliases so you can change things without breaking them</li>
<li>The flexibility to define your own help, usage, etc.</li>
<li>Optional tight integration with <a href="http://github.com/spf13/viper" target="_blank">viper</a> for 12-factor apps</li>
</ul>
<p>ğŸ‘€ Explore cobra&#39;s <a href="https://github.com/spf13/cobra" target="_blank">github page</a> and <a href="https://pkg.go.dev/github.com/spf13/cobra?tab=doc" target="_blank">documentation</a>.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Ch.2: Create a command" duration="0">
        <p>Let&#39;s see how to recreate our hello command using Cobra.</p>
<p>In <code>ğŸ“‚catption/codelab/chapter2</code> you will find a new <code>hello.go</code> with the skeleton of a cobra app:</p>
<pre><code>package main

import (
	&#34;fmt&#34;
	&#34;os&#34;
	&#34;strings&#34;

	&#34;github.com/spf13/cobra&#34;
)

var cmd = &amp;cobra.Command{
	// FIXME fill Use and Long fields
	RunE: func(_ *cobra.Command, args []string) error {
		return nil
	},
}

func main() {
	if err := cmd.Execute(); err != nil {
		os.Exit(1)
	}
}

func sayHello(args []string) error {
	if _, err := fmt.Printf(&#34;Hello %s!\n&#34;, strings.Join(args, &#34; &#34;)); err != nil {
		return err
	}
	return nil
}
</code></pre>
<p>âŒ¨ Fill the <code>Use</code> and <code>Long</code> fields of the <code>cmd</code><a href="https://pkg.go.dev/github.com/spf13/cobra?tab=doc#Command" target="_blank">Command struct</a>, then execute <code>go run .</code> to see the result.</p>
<p>âŒ¨ Call <code>sayHello</code> in the <code>RunE</code> function of <code>cmd</code>, in order to have a working hello command.</p>
<aside class="warning"><p><code>sayHello</code> may return an error, you may forward this error to the caller of <code>RunE</code>.</p>
</aside>
<p>âŒ¨ Finally fill the <code>Version</code> field of <code>cmd</code>, then execute <code>go run .</code> to see the result.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Ch.2: ğŸ Validate args" duration="0">
        <p>Our hello command needs at least one command line argument.</p>
<p>âŒ¨ Fill the <code>Args</code> field of <code>cmd</code> with the correct value in order to raise an error if hello doesn&#39;t receive any arguments.</p>
<aside class="special"><p>The type of <code>Args</code> is <a href="https://pkg.go.dev/github.com/spf13/cobra?tab=doc#PositionalArgs" target="_blank"><code>cobra.PositionalArgs</code></a>, which is a function type.<br>You could implement your own command-line arguments validator (this is not the goal here).</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Ch.2: End" duration="0">
        <p>ğŸ‰ Congratulations! You have completed chapter 2.</p>
<h2 class="checklist" is-upgraded>What we&#39;ve covered</h2>
<ul class="checklist">
<li>Discover <code>github/spf13/cobra</code></li>
<li>Create a cobra command</li>
<li>ğŸ Validate arguments</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Ch.3: Introduction" duration="0">
        <p>Enough of hello messages, let&#39;s start writing our cat caption CLI ğŸ±</p>
<h2 class="checklist" is-upgraded>What you&#39;ll learn</h2>
<ul class="checklist">
<li>Interpret flags</li>
<li>ğŸ Flag shorthand</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Ch.3: Interpret flags" duration="0">
        <p>In <code>ğŸ“‚catption/codelab/chapter3</code> you will find a <code>catption.go</code> with a new command:</p>
<pre><code>var (
	top, bottom            string
	size, fontSize, margin float64

	cmd = &amp;cobra.Command{
		Use:     &#34;catption&#34;,
		Long:    &#34;Cat caption generator CLI&#34;,
		Args:    cobra.ExactArgs(1),
		Version: &#34;chapter3&#34;,
		RunE: func(_ *cobra.Command, args []string) error {
			var name = args[0]

			cat, err := catption.LoadJPG(name)
			if err != nil {
				return err
			}

			cat.Top, cat.Bottom = top, bottom
			cat.Size, cat.FontSize, cat.Margin = size, fontSize, margin

			return cat.SaveJPG(&#34;out.jpg&#34;)
		},
	}
)
</code></pre>
<p>This command does 3 things:</p>
<ol type="1">
<li>Create a catption by loading a JPEG file</li>
<li>Setup the catption&#39;s parameters</li>
<li>Write the catption to <code>out.jpg</code></li>
</ol>
<p>However the variables used to setup the catption have not been initialized.</p>
<p>âŒ¨ In the <code>init</code> function, setup <code>cmd</code>&#39;s flags:</p>
<ul>
<li><code>top</code> and <code>bottom</code> string flags</li>
<li><code>size</code>, <code>fontSize</code> and <code>margin</code> float flags</li>
</ul>
<aside class="special"><p><a href="https://pkg.go.dev/github.com/spf13/cobra?tab=doc#Command.Flags" target="_blank"><code>Command.Flags</code></a> returns the <a href="https://pkg.go.dev/github.com/spf13/pflag?tab=doc#FlagSet" target="_blank"><code>FlagSet</code></a> of a command.<br>The <code>FlagSet</code> allows to setup the flags of a command.</p>
</aside>
<aside class="special"><p>Some functions of <code>FlagSet</code>, such as <a href="https://pkg.go.dev/github.com/spf13/pflag?tab=doc#IntVar" target="_blank"><code>IntVar</code></a>, expect a pointer as first argument.<br>Having <code>var i = 42</code>, use <code>&amp;i</code> to get a pointer to <code>i</code>, <code>&amp;i</code> has the type <code>*int</code>.</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Ch.3 Flag shorthand" duration="0">
        <p>TODO</p>


      </google-codelab-step>
    
      <google-codelab-step label="Ch.3: End" duration="0">
        <p>ğŸ‰ Congratulations! You have completed chapter 3.</p>
<h2 class="checklist" is-upgraded>What we&#39;ve covered</h2>
<ul class="checklist">
<li>Interpret flags</li>
<li>ğŸ Flag shorthand</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Ch.4: Introduction" duration="0">
        <h2 class="checklist" is-upgraded>What you&#39;ll learn</h2>
<ul class="checklist">
<li>Discover <code>github.com/spf13/viper</code></li>
<li>Read a config file</li>
<li>ğŸ ?</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Ch.4: Discover viper" duration="0">
        

      </google-codelab-step>
    
      <google-codelab-step label="Ch.4: Read config file" duration="0">
        

      </google-codelab-step>
    
      <google-codelab-step label="Ch.4: End" duration="0">
        <p>ğŸ‰ Congratulations! You have completed chapter 4.</p>
<h2 class="checklist" is-upgraded>What we&#39;ve covered</h2>
<ul class="checklist">
<li>Discover <code>github.com/spf13/viper</code></li>
<li>Read a config file</li>
<li>ğŸ ?</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Ch.5: Introduction" duration="0">
        <h2 class="checklist" is-upgraded>What you&#39;ll learn</h2>
<ul class="checklist">
<li>Connect cobra and viper</li>
<li>ğŸ Read environment variables</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Ch.5: cobra ğŸ”Œ viper" duration="0">
        

      </google-codelab-step>
    
      <google-codelab-step label="Ch.5: ğŸ Read env vars" duration="0">
        

      </google-codelab-step>
    
      <google-codelab-step label="Ch.5: End" duration="0">
        <p>ğŸ‰ Congratulations! You have completed chapter 5.</p>
<h2 class="checklist" is-upgraded>What we&#39;ve covered</h2>
<ul class="checklist">
<li>Connect cobra and viper</li>
<li>ğŸ Read environment variables</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Ch.6: Introduction" duration="0">
        <h2 class="checklist" is-upgraded>What you&#39;ll learn</h2>
<ul class="checklist">
<li>Create a subcommand</li>
<li>Write a config file</li>
<li>ğŸ Inject compile time variables</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Ch.6: Subcommands" duration="0">
        

      </google-codelab-step>
    
      <google-codelab-step label="Ch.6: Write config file" duration="0">
        

      </google-codelab-step>
    
      <google-codelab-step label="Ch.6: ğŸ Compile vars" duration="0">
        

      </google-codelab-step>
    
      <google-codelab-step label="Ch.6: End" duration="0">
        <p>ğŸ‰ Congratulations! You have completed chapter 6.</p>
<h2 class="checklist" is-upgraded>What we&#39;ve covered</h2>
<ul class="checklist">
<li>Create a subcommand</li>
<li>Write a config file</li>
<li>ğŸ Inject compile time variables</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Ch.7: Introduction" duration="0">
        <h2 class="checklist" is-upgraded>What you&#39;ll learn</h2>
<ul class="checklist">
<li>Interpret custom flags</li>
<li>ğŸ Discover <code>github.com/sirupsen/logrus</code></li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Ch.7: Custom flags" duration="0">
        

      </google-codelab-step>
    
      <google-codelab-step label="Ch.7: ğŸ Discover logrus" duration="0">
        

      </google-codelab-step>
    
      <google-codelab-step label="Ch.7: End" duration="0">
        <p>ğŸ‰ Congratulations! You have completed chapter 7.</p>
<h2 class="checklist" is-upgraded>What we&#39;ve covered</h2>
<ul class="checklist">
<li>Interpret custom flags</li>
<li>ğŸ Discover <code>github.com/sirupsen/logrus</code></li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Ch.8: Introduction" duration="0">
        <h2 class="checklist" is-upgraded>What you&#39;ll learn</h2>
<ul class="checklist">
<li>Discover <code>os/exec</code> package</li>
<li>Use conditional compilation</li>
<li>ğŸ  Use build tags</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Ch.8: Discover os/exec" duration="0">
        

      </google-codelab-step>
    
      <google-codelab-step label="Ch.8: Conditional compile" duration="0">
        

      </google-codelab-step>
    
      <google-codelab-step label="Ch.8: ğŸ Build tags" duration="0">
        

      </google-codelab-step>
    
      <google-codelab-step label="Ch.8: End" duration="0">
        <p>ğŸ‰ Congratulations! You have completed chapter 8.</p>
<h2 class="checklist" is-upgraded>What we&#39;ve covered</h2>
<ul class="checklist">
<li>Discover <code>os/exec</code> package</li>
<li>Use conditional compilation</li>
<li>ğŸ  Use build tags</li>
</ul>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>

</body>
</html>
